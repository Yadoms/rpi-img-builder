language: generic

#TODO : trusty is too old Ubuntu distribution, so this script doesn't work for now.
#TODO : We have to wait a newer distribution (works with 17.04) to make Pi image generation from Travis.
dist: trusty
sudo: required

services:
- docker

#limit to git depth to 1 because don't use any git command in this script
git:
  depth: 1
  
script:
#get docker image (ubuntu 17.04, 64bits with package installed)
- docker pull yadoms/ubuntu_rpi_image_32

#start the docker container
- docker run -dit --privileged --name buildvm yadoms/ubuntu_rpi_image_32 /bin/bash "uname -a;"

#display linux version
- docker exec --privileged buildvm /bin/bash -c "uname -a;"

#create folder
- docker exec --privileged buildvm /bin/bash -c "mkdir builder;"

#copy file to container
- docker cp ./ buildvm:builder

#execute the image building
- docker exec -u root --privileged buildvm /bin/bash -c "cd builder; ./create-yadoms-pi-image ${YADOMS_VERSION}"

#copy result
- docker cp buildvm:builder/Yadoms-${YADOMS_VERSION}-RaspberryPI.img.zip Yadoms-${YADOMS_VERSION}-RaspberryPI.img.zip


after_success:
# Upload image
- echo 'Upload image to ${YADOMS_UPLOAD_URL}...'
- curl --ftp-create-dirs -T Yadoms-${YADOMS_VERSION}-RaspberryPI.img.zip -u $FTP_USER:$FTP_PASSWORD ${YADOMS_UPLOAD_URL}

